<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Romessk v0.2 ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Crimson Pro',Georgia,serif;background:#0c0f0a;color:#e8ede4;overflow:hidden}
button,input,textarea{font-family:inherit;font-size:inherit}

:root{
  --bg:#0c0f0a;--bg2:#131810;--bg3:#1a2016;--bg4:#202820;
  --border:#2a3528;--accent:#6dbe8a;--accentDim:rgba(109,190,138,.12);
  --accentFg:#071208;--text:#e8ede4;--text2:#8aaa90;--text3:#4a6050;
  --gold:#c8a84b;--danger:#c85858;
  --r:14px;--r2:9px;--tr:.16s ease;
  --shadow:0 12px 48px rgba(0,0,0,.6);
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;overflow:hidden}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:300px;min-width:300px;
  background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  transition:transform .25s ease;
}
.sb-head{
  padding:1rem 1.2rem .8rem;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.6rem;
}
.sb-logo{
  font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;
  color:var(--accent);letter-spacing:-.02em;flex:1;
}
.sb-logo span{color:var(--text3);font-size:.55rem;font-weight:400;font-family:'Crimson Pro',serif;letter-spacing:.1em;text-transform:uppercase;vertical-align:super}
.sb-user{
  display:flex;align-items:center;gap:.6rem;
  padding:.7rem 1.2rem;
  border-bottom:1px solid var(--border);
  background:var(--bg3);
}
.av{
  width:36px;height:36px;border-radius:50%;
  background:var(--accentDim);border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:.95rem;font-weight:700;color:var(--accent);
  flex-shrink:0;overflow:hidden;cursor:pointer;
}
.av img{width:100%;height:100%;object-fit:cover}
.sb-uname{font-size:.85rem;font-weight:600;flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.sb-ustatus{font-size:.7rem;color:var(--accent)}
.sb-search{padding:.6rem 1rem;border-bottom:1px solid var(--border)}
.sb-search input{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:20px;padding:.38rem .85rem;color:var(--text);outline:none;
  font-size:.82rem;transition:border-color .15s;
}
.sb-search input:focus{border-color:var(--accent)}
.sb-search input::placeholder{color:var(--text3)}
.sb-tabs{display:flex;border-bottom:1px solid var(--border)}
.sb-tab{
  flex:1;padding:.5rem;border:none;background:transparent;
  color:var(--text3);font-size:.75rem;font-weight:600;cursor:pointer;
  border-bottom:2px solid transparent;transition:var(--tr);
}
.sb-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.sb-list{flex:1;overflow-y:auto;padding:.3rem 0}
.sb-list::-webkit-scrollbar{width:3px}
.sb-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* –î–∏–∞–ª–æ–≥ –≤ —Å–ø–∏—Å–∫–µ */
.dlg-item{
  display:flex;align-items:center;gap:.7rem;
  padding:.6rem 1.2rem;cursor:pointer;
  transition:background .12s;position:relative;
}
.dlg-item:hover{background:var(--bg3)}
.dlg-item.active{background:var(--accentDim)}
.dlg-item.active .dlg-name{color:var(--accent)}
.dlg-av{
  width:42px;height:42px;border-radius:50%;flex-shrink:0;
  background:var(--bg4);border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;font-weight:700;color:var(--text2);overflow:hidden;
}
.dlg-av img{width:100%;height:100%;object-fit:cover}
.dlg-info{flex:1;min-width:0}
.dlg-name{font-size:.88rem;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.dlg-preview{font-size:.74rem;color:var(--text3);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;margin-top:.1rem}
.dlg-meta{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;flex-shrink:0}
.dlg-time{font-size:.65rem;color:var(--text3)}
.dlg-badge{
  background:var(--accent);color:var(--accentFg);
  border-radius:10px;padding:.05rem .42rem;
  font-size:.65rem;font-weight:700;min-width:18px;text-align:center;
}
.sb-empty{text-align:center;padding:3rem 1rem;color:var(--text3);font-size:.84rem;font-style:italic}

/* –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ */
.new-dm-btn{
  margin:.8rem 1rem;padding:.55rem 1rem;
  background:var(--accentDim);color:var(--accent);
  border:1.5px solid var(--accent);border-radius:var(--r2);
  cursor:pointer;font-size:.82rem;font-weight:700;
  transition:var(--tr);display:flex;align-items:center;justify-content:center;gap:.4rem;
}
.new-dm-btn:hover{background:var(--accent);color:var(--accentFg)}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}

/* –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω */
.chat-empty{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--text3);gap:1rem;
}
.chat-empty-icon{font-size:3.5rem;opacity:.25}
.chat-empty h2{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--text2);font-weight:700}
.chat-empty p{font-size:.88rem;font-style:italic}

/* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
.chat-head{
  padding:.7rem 1.4rem;background:var(--bg2);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.8rem;flex-shrink:0;
}
.chat-head-av{
  width:38px;height:38px;border-radius:50%;flex-shrink:0;
  background:var(--bg4);border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;font-weight:700;color:var(--text2);overflow:hidden;
}
.chat-head-av img{width:100%;height:100%;object-fit:cover}
.chat-head-info{flex:1;min-width:0}
.chat-head-name{font-size:1rem;font-weight:700}
.chat-head-status{font-size:.72rem;color:var(--accent)}
.chat-head-btn{
  background:transparent;border:none;color:var(--text3);
  cursor:pointer;padding:.3rem .5rem;border-radius:var(--r2);
  font-size:.9rem;transition:var(--tr);
}
.chat-head-btn:hover{background:var(--bg3);color:var(--text)}
.mob-back{display:none}

/* –°–æ–æ–±—â–µ–Ω–∏—è */
.chat-msgs{
  flex:1;overflow-y:auto;padding:1.2rem 1.4rem;
  display:flex;flex-direction:column;gap:.55rem;
}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç–∞ */
.msg-date-sep{
  text-align:center;font-size:.68rem;color:var(--text3);
  margin:.4rem 0;display:flex;align-items:center;gap:.6rem;
}
.msg-date-sep::before,.msg-date-sep::after{content:'';flex:1;height:1px;background:var(--border)}

/* –°–æ–æ–±—â–µ–Ω–∏–µ */
.msg{display:flex;gap:.55rem;align-items:flex-end;max-width:75%}
.msg.mine{align-self:flex-end;flex-direction:row-reverse}
.msg.other{align-self:flex-start}
.msg-av{
  width:28px;height:28px;border-radius:50%;flex-shrink:0;
  background:var(--bg4);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;font-weight:700;color:var(--text2);overflow:hidden;
}
.msg-av img{width:100%;height:100%;object-fit:cover}
.msg-bubble{
  padding:.55rem .85rem;border-radius:18px;
  font-size:.9rem;line-height:1.55;word-break:break-word;
  position:relative;
}
.msg.mine .msg-bubble{
  background:var(--accent);color:var(--accentFg);
  border-bottom-right-radius:4px;
}
.msg.other .msg-bubble{
  background:var(--bg3);color:var(--text);
  border:1px solid var(--border);border-bottom-left-radius:4px;
}
.msg-time{
  font-size:.6rem;opacity:.6;margin-top:.25rem;
  display:block;text-align:right;white-space:nowrap;
}
.msg.other .msg-time{text-align:left}
.msg-status{font-size:.62rem;opacity:.7;margin-left:.2rem}

/* Typing indicator */
.typing-indicator{
  display:none;align-self:flex-start;
  background:var(--bg3);border:1px solid var(--border);
  border-radius:18px;border-bottom-left-radius:4px;
  padding:.5rem .85rem;gap:.3rem;align-items:center;
}
.typing-indicator.show{display:flex}
.typing-dot{
  width:6px;height:6px;border-radius:50%;background:var(--text3);
  animation:typingBounce 1.2s infinite;
}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
.chat-input-area{
  padding:.8rem 1.2rem;background:var(--bg2);
  border-top:1px solid var(--border);
  display:flex;align-items:flex-end;gap:.7rem;flex-shrink:0;
}
.chat-input-wrap{
  flex:1;background:var(--bg3);border:1px solid var(--border);
  border-radius:22px;padding:.5rem 1rem;
  display:flex;align-items:flex-end;gap:.5rem;
  transition:border-color .15s;
}
.chat-input-wrap:focus-within{border-color:var(--accent)}
.chat-input{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--text);resize:none;max-height:120px;
  font-size:.92rem;line-height:1.5;
}
.chat-input::placeholder{color:var(--text3)}
.send-btn{
  width:42px;height:42px;border-radius:50%;flex-shrink:0;
  background:var(--accent);color:var(--accentFg);
  border:none;cursor:pointer;font-size:1.1rem;
  display:flex;align-items:center;justify-content:center;
  transition:var(--tr);transform:scale(1);
}
.send-btn:hover{filter:brightness(1.1);transform:scale(1.05)}
.send-btn:active{transform:scale(.95)}
.send-btn:disabled{opacity:.4;cursor:default;transform:scale(1)}

/* ‚îÄ‚îÄ –ú–û–î–ê–õ–ö–ò ‚îÄ‚îÄ */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.75);backdrop-filter:blur(6px);
  z-index:500;align-items:center;justify-content:center;padding:1rem;
}
.overlay.open{display:flex}
.modal{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:1.6rem;width:100%;max-width:420px;
  box-shadow:var(--shadow);
}
.modal h2{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;margin-bottom:1.2rem}
.fg{margin-bottom:.85rem}
.fg label{display:block;font-size:.74rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:.3rem}
.fi{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);color:var(--text);padding:.45rem .7rem;
  outline:none;transition:border-color .15s;
}
.fi:focus{border-color:var(--accent)}
.m-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1.2rem}
.btn{display:inline-flex;align-items:center;gap:.3rem;padding:.45rem 1rem;border:none;border-radius:var(--r2);cursor:pointer;font-size:.84rem;font-weight:700;transition:var(--tr)}
.btn-prim{background:var(--accent);color:var(--accentFg)}
.btn-prim:hover{filter:brightness(1.1)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--bg3);color:var(--text)}
.err-msg{font-size:.76rem;color:var(--danger);background:rgba(200,88,88,.1);border-radius:var(--r2);padding:.35rem .55rem;margin-bottom:.5rem;display:none}

/* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–æ–≤–æ–≥–æ DM */
.user-pick-list{max-height:260px;overflow-y:auto;margin:.6rem 0}
.user-pick-item{
  display:flex;align-items:center;gap:.7rem;
  padding:.55rem .7rem;border-radius:var(--r2);cursor:pointer;transition:background .12s;
}
.user-pick-item:hover{background:var(--bg3)}
.user-pick-item.selected{background:var(--accentDim)}
.upi-av{
  width:36px;height:36px;border-radius:50%;background:var(--bg4);
  border:1.5px solid var(--border);display:flex;align-items:center;
  justify-content:center;font-size:.9rem;font-weight:700;color:var(--text2);overflow:hidden;flex-shrink:0;
}
.upi-av img{width:100%;height:100%;object-fit:cover}
.upi-name{font-size:.88rem;font-weight:600}
.upi-empty{text-align:center;padding:1.5rem;color:var(--text3);font-style:italic;font-size:.84rem}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--bg4);border:1px solid var(--border);border-radius:var(--r2);
  padding:.55rem 1.1rem;font-size:.82rem;font-weight:600;
  opacity:0;transition:all .25s;z-index:999;pointer-events:none;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:var(--accent);color:var(--accent)}
.toast.bad{border-color:var(--danger);color:var(--danger)}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.lov{
  position:fixed;inset:0;background:rgba(12,15,10,.8);
  backdrop-filter:blur(4px);z-index:800;
  display:none;align-items:center;justify-content:center;
}
.lov.show{display:flex}
.spinner{
  width:36px;height:36px;border-radius:50%;
  border:3px solid var(--border);border-top-color:var(--accent);
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
.auth-screen{
  position:fixed;inset:0;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  z-index:900;padding:1rem;
}
.auth-box{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:2rem;width:100%;max-width:380px;
  box-shadow:var(--shadow);
}
.auth-logo{
  font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;
  color:var(--accent);text-align:center;margin-bottom:.3rem;
}
.auth-sub{text-align:center;color:var(--text3);font-size:.82rem;font-style:italic;margin-bottom:1.6rem}
.auth-toggle{text-align:center;margin-top:1rem;font-size:.82rem;color:var(--text3)}
.auth-toggle a{color:var(--accent);cursor:pointer;text-decoration:none}
.auth-toggle a:hover{text-decoration:underline}

/* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
.sett-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.75);backdrop-filter:blur(6px);
  z-index:500;align-items:center;justify-content:center;padding:1rem;
}
.sett-overlay.open{display:flex}
.sett-box{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);width:100%;max-width:460px;
  box-shadow:var(--shadow);max-height:90vh;overflow-y:auto;
}
.sett-head{
  display:flex;align-items:center;gap:.7rem;
  padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);position:sticky;top:0;
  background:var(--bg2);z-index:1;
}
.sett-head h2{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;flex:1}
.sett-body{padding:1.2rem 1.4rem;display:flex;flex-direction:column;gap:.8rem}
.sett-card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:1rem 1.1rem;
}
.sett-card-title{font-size:.78rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text3);margin-bottom:.75rem}
.th-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem}
.th-dot{
  display:flex;align-items:center;gap:.5rem;
  padding:.45rem .6rem;border-radius:var(--r2);cursor:pointer;
  border:1.5px solid transparent;transition:var(--tr);font-size:.78rem;font-weight:600;
}
.th-dot:hover{border-color:var(--border);background:var(--bg4)}
.th-dot.active{border-color:var(--accent);background:var(--accentDim)}
.th-dot-c{width:14px;height:14px;border-radius:50%;flex-shrink:0}
.irow{display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border);font-size:.84rem}
.irow:last-child{border-bottom:none}
.irow span{color:var(--text2)}
</style>
@media(max-width:640px){
  .sidebar{
    position:fixed;inset:0;z-index:200;
    transform:translateX(0);width:100%;
  }
  .sidebar.hidden{transform:translateX(-100%)}
  .chat-area{width:100%}
  .mob-back{display:flex !important}
  .chat-msgs{padding:.9rem .9rem}
  .chat-input-area{padding:.6rem .9rem}
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="auth-screen" id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo"><img src="assets/RM.png" alt="Romessk" style="height:56px;width:auto;display:block;margin:0 auto"/></div>
    <div class="auth-sub">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ¬∑ Alpha 0.2</div>

    <!-- LOGIN -->
    <div id="auth-login">
      <div class="fg"><label>Email</label><input class="fi" id="login-email" type="email" placeholder="you@email.com" autocomplete="email"/></div>
      <div class="fg"><label>–ü–∞—Ä–æ–ª—å</label><input class="fi" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <div class="err-msg" id="login-err"></div>
      <button class="btn btn-prim" style="width:100%;justify-content:center" onclick="doLogin()">–í–æ–π—Ç–∏</button>
      <div class="auth-toggle">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showReg()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
    </div>

    <!-- REGISTER -->
    <div id="auth-reg" style="display:none">
      <div class="fg"><label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input class="fi" id="reg-name" placeholder="—á–∏—Ç–∞—Ç–µ–ª—å_–∏–≤–∞–Ω"/></div>
      <div class="fg"><label>Email</label><input class="fi" id="reg-email" type="email" placeholder="you@email.com"/></div>
      <div class="fg"><label>–ü–∞—Ä–æ–ª—å</label><input class="fi" id="reg-pass" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"/></div>
      <div class="err-msg" id="reg-err"></div>
      <button class="btn btn-prim" style="width:100%;justify-content:center" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      <div class="auth-toggle">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showLogin()">–í–æ–π—Ç–∏</a></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="app" style="display:none">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sb-head">
      <div class="sb-logo"><img src="assets/RMI.png" alt="Romessk" style="height:38px;width:auto;display:block"/></div>
      <button class="chat-head-btn" title="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onclick="openNewDM()" style="font-size:1.1rem">‚úè</button>
      <button class="chat-head-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" onclick="openSettings()">‚öô</button>
      <button class="chat-head-btn" title="–í—ã–π—Ç–∏" onclick="doLogout()">‚éã</button>
    </div>
    <div class="sb-user" id="sb-user">
      <div class="av" id="my-av">?</div>
      <div style="flex:1;min-width:0">
        <div class="sb-uname" id="my-name">‚Äî</div>
        <div class="sb-ustatus">‚óè –æ–Ω–ª–∞–π–Ω</div>
      </div>
    </div>
    <div class="sb-search">
      <input id="dlg-search" placeholder="üîç –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤..." oninput="filterDialogs()"/>
    </div>
    <div style="padding:.4rem 1rem .2rem">
      <div class="dlg-item" id="self-chat-btn" onclick="openSelfChat()" style="border-radius:var(--r2);padding:.55rem .7rem;background:var(--bg3)">
        <div class="dlg-av" style="background:var(--accentDim);border-color:var(--accent);color:var(--accent)">‚≠ê</div>
        <div class="dlg-info">
          <div class="dlg-name" style="color:var(--accent)">–õ–∏—á–Ω–æ–µ</div>
          <div class="dlg-preview">–ó–∞–º–µ—Ç–∫–∏ –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∏</div>
        </div>
      </div>
    </div>
    <div class="sb-list" id="dlg-list">
      <div class="sb-empty">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤.<br/>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π!</div>
    </div>
    <button class="new-dm-btn" onclick="openNewDM()">‚úè –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</button>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <!-- –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω -->
    <div class="chat-empty" id="chat-empty">
      <div class="chat-empty-icon">‚úâ</div>
      <h2>Romessk</h2>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π</p>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç -->
    <div id="chat-view" style="display:none;flex-direction:column;height:100%">
      <div class="chat-head">
        <button class="chat-head-btn mob-back" onclick="showSidebar()" style="font-size:1.1rem;display:none">‚Üê</button>
        <div class="chat-head-av" id="chat-head-av">?</div>
        <div class="chat-head-info">
          <div class="chat-head-name" id="chat-head-name">‚Äî</div>
          <div class="chat-head-status" id="chat-head-status">‚óè –æ–Ω–ª–∞–π–Ω</div>
        </div>
      </div>
      <div class="chat-msgs" id="chat-msgs">
        <div class="typing-indicator" id="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            oninput="autoResize(this);onTyping()"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
        </div>
        <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ -->
<div class="overlay" id="m-newdm">
  <div class="modal">
    <h2>‚úè –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h2>
    <div class="fg">
      <label>–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
      <input class="fi" id="newdm-search" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." oninput="searchUsers()"/>
    </div>
    <div class="user-pick-list" id="user-pick-list">
      <div class="upi-empty">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è</div>
    </div>
    <div class="err-msg" id="newdm-err"></div>
    <div class="m-actions">
      <button class="btn btn-ghost" onclick="closeOverlay('m-newdm')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-prim" onclick="startDM()">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="sett-overlay" id="sett-overlay">
  <div class="sett-box">
    <div class="sett-head">
      <h2>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <button class="chat-head-btn" onclick="closeSettings()">‚úï</button>
    </div>
    <div class="sett-body">
      <div class="sett-card">
        <div class="sett-card-title">üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
        <div class="th-grid" id="th-grid"></div>
      </div>
      <div class="sett-card">
        <div class="sett-card-title">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        <div id="sett-profile-info"></div>
      </div>
      <div class="sett-card">
        <div class="sett-card-title">‚Ñπ –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
        <div class="irow"><span>–ù–∞–∑–≤–∞–Ω–∏–µ</span><strong>Romessk</strong></div>
        <div class="irow"><span>–í–µ—Ä—Å–∏—è</span><strong>Alpha 0.2</strong></div>
        <div class="irow"><span>–°–µ—Ä–≤–µ—Ä</span><strong>Supabase Cloud</strong></div>
        <div class="irow"><span>–ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å</span><strong>Romsk</strong></div>
      </div>
      <button class="btn" style="background:var(--danger);color:#fff;width:100%;justify-content:center" onclick="doLogout();closeSettings()">‚éã –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="lov" id="lov"><div class="spinner"></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
"use strict";

const SURL = 'https://emqbosamvstewjrysveh.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtcWJvc2FtdnN0ZXdqcnlzdmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NzM3NTYsImV4cCI6MjA4NzI0OTc1Nn0.274Kvn0v-OKSuD5oSFTrKlUjzHDopNEuki_SqATG4YU';
const sb = supabase.createClient(SURL, SKEY, {
  realtime: { params: { eventsPerSecond: 10 } }
});

let curUser = null, curProfile = null;
let curConvId = null, curOtherUser = null;
let isSelfChat = false;

// ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ
const THEMES = [
  {k:'forest',   n:'üå≤ –õ–µ—Å–Ω–∞—è',    bg:'#0c0f0a', accent:'#6dbe8a'},
  {k:'midnight', n:'üåë –ü–æ–ª–Ω–æ—á—å',   bg:'#13131a', accent:'#7c6af7'},
  {k:'ocean',    n:'üåä –û–∫–µ–∞–Ω',     bg:'#0c1828', accent:'#38bdf8'},
  {k:'rose',     n:'üå∏ –†–æ–∑–æ–≤–∞—è',   bg:'#24131a', accent:'#f472b6'},
  {k:'parch',    n:'üìú –ü–µ—Ä–≥–∞–º–µ–Ω—Ç', bg:'#f5f0e8', accent:'#8b5e3c'},
  {k:'slate',    n:'ü™® –°–µ—Ä–∞—è',     bg:'#e8eaed', accent:'#5865f2'},
];
const THEME_VARS = {
  forest:   {bg:'#0c0f0a',bg2:'#131810',bg3:'#1a2016',bg4:'#202820',border:'#2a3528',accent:'#6dbe8a',accentDim:'rgba(109,190,138,.12)',accentFg:'#071208',text:'#e8ede4',text2:'#8aaa90',text3:'#4a6050'},
  midnight: {bg:'#13131a',bg2:'#1a1a24',bg3:'#20202e',bg4:'#26263a',border:'#2e2e45',accent:'#7c6af7',accentDim:'rgba(124,106,247,.12)',accentFg:'#0d0b1f',text:'#e4e2f5',text2:'#8a86c0',text3:'#4a4870'},
  ocean:    {bg:'#0c1828',bg2:'#0f2035',bg3:'#162840',bg4:'#1c3050',border:'#1e3a58',accent:'#38bdf8',accentDim:'rgba(56,189,248,.12)',accentFg:'#021020',text:'#e0f0fa',text2:'#6da8cc',text3:'#3a6888'},
  rose:     {bg:'#24131a',bg2:'#2e1820',bg3:'#3a1f28',bg4:'#452530',border:'#5a2a38',accent:'#f472b6',accentDim:'rgba(244,114,182,.12)',accentFg:'#1a0510',text:'#fde8f0',text2:'#c08099',text3:'#7a4060'},
  parch:    {bg:'#f5f0e8',bg2:'#ede7d8',bg3:'#e4dcc8',bg4:'#dbd2b8',border:'#c8bfa0',accent:'#8b5e3c',accentDim:'rgba(139,94,60,.1)',accentFg:'#fff8f0',text:'#2a1f10',text2:'#6b5040',text3:'#a08060'},
  slate:    {bg:'#e8eaed',bg2:'#dfe1e6',bg3:'#d4d6db',bg4:'#c8cace',border:'#b0b4ba',accent:'#5865f2',accentDim:'rgba(88,101,242,.1)',accentFg:'#fff',text:'#1a1c2e',text2:'#505580',text3:'#8890b0'},
};

function applyTheme(k){
  const v = THEME_VARS[k] || THEME_VARS.forest;
  const root = document.documentElement;
  Object.entries(v).forEach(([key,val]) => root.style.setProperty('--'+key, val));
  localStorage.setItem('rm-theme', k);
  buildThemeGrid();
}

function buildThemeGrid(){
  const cur = localStorage.getItem('rm-theme')||'forest';
  const el = document.getElementById('th-grid');
  if(!el) return;
  el.innerHTML = THEMES.map(th => `
    <div class="th-dot ${th.k===cur?'active':''}" onclick="applyTheme('${th.k}')">
      <div class="th-dot-c" style="background:${th.accent};box-shadow:0 0 0 2px ${th.bg}"></div>
      ${th.n}
    </div>`).join('');
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function openSettings(){
  buildThemeGrid();
  // Profile info
  const el = document.getElementById('sett-profile-info');
  if(el && curProfile){
    const name = curProfile.username || curUser?.email?.split('@')[0] || '‚Äî';
    el.innerHTML = `
      <div class="irow"><span>–ò–º—è</span><strong>${esc(name)}</strong></div>
      <div class="irow"><span>Email</span><strong>${esc(curUser?.email||'‚Äî')}</strong></div>`;
  }
  document.getElementById('sett-overlay').classList.add('open');
}
function closeSettings(){ document.getElementById('sett-overlay').classList.remove('open'); }

// ‚îÄ‚îÄ SELF CHAT (–õ–∏—á–Ω–æ–µ) ‚îÄ‚îÄ
function openSelfChat(){
  isSelfChat = true;
  curConvId = 'self-'+curUser.id;
  curOtherUser = null;

  document.querySelectorAll('.dlg-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('self-chat-btn').classList.add('active');

  document.getElementById('chat-head-av').innerHTML = '‚≠ê';
  document.getElementById('chat-head-av').style.background = 'var(--accentDim)';
  document.getElementById('chat-head-av').style.color = 'var(--accent)';
  document.getElementById('chat-head-name').textContent = '–õ–∏—á–Ω–æ–µ';
  document.getElementById('chat-head-status').textContent = 'üìù –ó–∞–º–µ—Ç–∫–∏ –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∏';

  document.getElementById('chat-empty').style.display='none';
  const cv = document.getElementById('chat-view');
  cv.style.display='flex';

  if(window.innerWidth <= 640){
    document.getElementById('sidebar').classList.add('hidden');
  }

  loadSelfMessages();
  document.getElementById('chat-input').focus();
}

function loadSelfMessages(){
  const key = 'rm-self-'+curUser.id;
  const msgs = JSON.parse(localStorage.getItem(key)||'[]');
  renderSelfMessages(msgs);
}

function renderSelfMessages(msgs){
  const el = document.getElementById('chat-msgs');
  const typingEl = document.getElementById('typing-indicator');
  if(!msgs.length){
    el.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text3);font-style:italic">–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∏</div>';
    el.appendChild(typingEl);
    scrollToBottom();
    return;
  }
  const myAv = curProfile?.avatar_url
    ? `<img src="${esc(curProfile.avatar_url)}" alt=""/>`
    : (curProfile?.username||'?')[0].toUpperCase();
  let html = '';
  let lastDate = null;
  msgs.forEach(m => {
    const d = new Date(m.ts);
    const dateStr = d.toLocaleDateString('ru',{day:'numeric',month:'long'});
    if(dateStr !== lastDate){ html+=`<div class="msg-date-sep">${dateStr}</div>`; lastDate=dateStr; }
    const time = d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
    html += `<div class="msg mine">
      <div class="msg-av">${myAv}</div>
      <div>
        <div class="msg-bubble">${esc(m.text)}</div>
        <span class="msg-time">${time}</span>
      </div>
    </div>`;
  });
  el.innerHTML = html;
  el.appendChild(typingEl);
  scrollToBottom();
}

function saveSelfMessage(text){
  const key = 'rm-self-'+curUser.id;
  const msgs = JSON.parse(localStorage.getItem(key)||'[]');
  msgs.push({text, ts: new Date().toISOString()});
  localStorage.setItem(key, JSON.stringify(msgs));
  loadSelfMessages();
}

let allDialogs = [];
let msgSubscription = null;
let typingTimeout = null;
let userSearchTimeout = null;
let selectedUserId = null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
sb.auth.onAuthStateChange(async (event, session) => {
  if (session?.user) {
    curUser = session.user;
    await loadMyProfile();
    showApp();
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
    applyTheme(localStorage.getItem('rm-theme')||'forest');
    await loadDialogs();
    subscribeToNewMessages();
  } else {
    curUser = null;
    curProfile = null;
    showAuthScreen();
  }
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function showLogin(){ document.getElementById('auth-login').style.display='block'; document.getElementById('auth-reg').style.display='none'; }
function showReg()  { document.getElementById('auth-login').style.display='none';  document.getElementById('auth-reg').style.display='block'; }

async function doLogin(){
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-err');
  errEl.style.display='none';
  if(!email||!pass){ errEl.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'; errEl.style.display='block'; return; }
  setLoad(true);
  const {error} = await sb.auth.signInWithPassword({email, password:pass});
  setLoad(false);
  if(error){ errEl.textContent=error.message; errEl.style.display='block'; }
}

async function doRegister(){
  const name  = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value;
  const errEl = document.getElementById('reg-err');
  errEl.style.display='none';
  if(!name||!email||!pass){ errEl.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'; errEl.style.display='block'; return; }
  if(pass.length<6){ errEl.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'; errEl.style.display='block'; return; }
  setLoad(true);
  const {data, error} = await sb.auth.signUp({email, password:pass, options:{data:{username:name}}});
  if(error){ errEl.textContent=error.message; errEl.style.display='block'; setLoad(false); return; }
  if(data?.user){
    await sb.from('profiles').upsert({id:data.user.id, username:name},{onConflict:'id'});
  }
  setLoad(false);
  toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+name+'! üéâ');
}

async function doLogout(){
  if(msgSubscription) sb.removeChannel(msgSubscription);
  await sb.auth.signOut();
  curConvId=null; curOtherUser=null; allDialogs=[];
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
async function loadMyProfile(){
  const {data} = await sb.from('profiles').select('*').eq('id', curUser.id).single();
  curProfile = data;
  const name = data?.username || curUser.email.split('@')[0];
  document.getElementById('my-name').textContent = name;
  const avEl = document.getElementById('my-av');
  if(data?.avatar_url){
    avEl.innerHTML = `<img src="${esc(data.avatar_url)}" alt=""/>`;
  } else {
    avEl.textContent = name[0].toUpperCase();
  }
}

// ‚îÄ‚îÄ APP SHOW/HIDE ‚îÄ‚îÄ
function showApp(){
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').style.display='flex';
}
function showAuthScreen(){
  document.getElementById('auth-screen').style.display='flex';
  document.getElementById('app').style.display='none';
}

// ‚îÄ‚îÄ DIALOGS ‚îÄ‚îÄ
async function loadDialogs(){
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const {data:convs} = await sb.from('conversations')
    .select('*')
    .or(`user1_id.eq.${curUser.id},user2_id.eq.${curUser.id}`)
    .order('last_message_at', {ascending:false, nullsFirst:false});

  if(!convs?.length){
    document.getElementById('dlg-list').innerHTML = '<div class="sb-empty">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤.<br/>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
    allDialogs = [];
    return;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
  const otherIds = convs.map(c => c.user1_id === curUser.id ? c.user2_id : c.user1_id);
  const {data:profiles} = await sb.from('profiles').select('id,username,avatar_url').in('id', otherIds);
  const profMap = Object.fromEntries((profiles||[]).map(p=>[p.id,p]));

  allDialogs = convs.map(c => {
    const otherId = c.user1_id === curUser.id ? c.user2_id : c.user1_id;
    return { ...c, otherProfile: profMap[otherId]||{id:otherId,username:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} };
  });

  renderDialogs(allDialogs);
}

function renderDialogs(list){
  const el = document.getElementById('dlg-list');
  if(!list.length){ el.innerHTML='<div class="sb-empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  el.innerHTML = list.map(c => {
    const p = c.otherProfile;
    const name = p.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    const av = p.avatar_url
      ? `<img src="${esc(p.avatar_url)}" alt=""/>`
      : name[0].toUpperCase();
    const preview = c.last_message ? esc(c.last_message).slice(0,40)+(c.last_message.length>40?'‚Ä¶':'') : '<i>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</i>';
    const time = c.last_message_at ? fmtTime(c.last_message_at) : '';
    const active = c.id === curConvId ? ' active' : '';
    return `<div class="dlg-item${active}" onclick="openConversation('${c.id}','${p.id}')">
      <div class="dlg-av">${av}</div>
      <div class="dlg-info">
        <div class="dlg-name">${esc(name)}</div>
        <div class="dlg-preview">${preview}</div>
      </div>
      <div class="dlg-meta">
        <div class="dlg-time">${time}</div>
      </div>
    </div>`;
  }).join('');
}

function filterDialogs(){
  const q = document.getElementById('dlg-search').value.toLowerCase();
  if(!q){ renderDialogs(allDialogs); return; }
  renderDialogs(allDialogs.filter(c =>
    (c.otherProfile?.username||'').toLowerCase().includes(q) ||
    (c.last_message||'').toLowerCase().includes(q)
  ));
}

// ‚îÄ‚îÄ OPEN CONVERSATION ‚îÄ‚îÄ
async function openConversation(convId, otherUserId){
  isSelfChat = false;
  curConvId = convId;

  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ –≤ —Å–ø–∏—Å–∫–µ
  document.querySelectorAll('.dlg-item').forEach(el => {
    el.classList.toggle('active', el.getAttribute('onclick')?.includes(convId));
  });

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
  const {data:profile} = await sb.from('profiles').select('*').eq('id', otherUserId).single();
  curOtherUser = profile || {id:otherUserId, username:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'};

  const name = curOtherUser.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  const av = curOtherUser.avatar_url
    ? `<img src="${esc(curOtherUser.avatar_url)}" alt=""/>`
    : name[0].toUpperCase();

  document.getElementById('chat-head-av').innerHTML = av;
  document.getElementById('chat-head-name').textContent = name;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
  document.getElementById('chat-empty').style.display='none';
  const cv = document.getElementById('chat-view');
  cv.style.display='flex';

  // –ù–∞ –º–æ–±–∏–ª–µ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
  if(window.innerWidth <= 640){
    document.getElementById('sidebar').classList.add('hidden');
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  await loadMessages(convId);

  // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ
  subscribeToConversation(convId);

  // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  document.getElementById('chat-input').focus();
}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
async function loadMessages(convId){
  const msgsEl = document.getElementById('chat-msgs');
  msgsEl.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text3);font-style:italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

  const {data:msgs} = await sb.from('messages')
    .select('*')
    .eq('conversation_id', convId)
    .order('created_at', {ascending:true});

  renderMessages(msgs||[]);
}

function renderMessages(msgs){
  const el = document.getElementById('chat-msgs');
  const typingEl = document.getElementById('typing-indicator');

  if(!msgs.length){
    el.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text3);font-style:italic">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É!</div>';
    el.appendChild(typingEl);
    scrollToBottom();
    return;
  }

  let html = '';
  let lastDate = null;
  const myAv = curProfile?.avatar_url
    ? `<img src="${esc(curProfile.avatar_url)}" alt=""/>`
    : (curProfile?.username||'?')[0].toUpperCase();
  const otherAv = curOtherUser?.avatar_url
    ? `<img src="${esc(curOtherUser.avatar_url)}" alt=""/>`
    : (curOtherUser?.username||'?')[0].toUpperCase();

  msgs.forEach(m => {
    const d = new Date(m.created_at);
    const dateStr = d.toLocaleDateString('ru', {day:'numeric',month:'long'});
    if(dateStr !== lastDate){
      html += `<div class="msg-date-sep">${dateStr}</div>`;
      lastDate = dateStr;
    }
    const isMine = m.sender_id === curUser.id;
    const av = isMine ? myAv : otherAv;
    const time = d.toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit'});
    const status = isMine ? (m.is_read ? ' ‚úì‚úì' : ' ‚úì') : '';
    html += `<div class="msg ${isMine?'mine':'other'}">
      <div class="msg-av">${av}</div>
      <div>
        <div class="msg-bubble">${esc(m.content)}</div>
        <span class="msg-time">${time}<span class="msg-status">${status}</span></span>
      </div>
    </div>`;
  });

  el.innerHTML = html;
  el.appendChild(typingEl);
  scrollToBottom();
}

function appendMessage(msg){
  const el = document.getElementById('chat-msgs');
  const typingEl = document.getElementById('typing-indicator');
  const isMine = msg.sender_id === curUser.id;
  const myAv = curProfile?.avatar_url
    ? `<img src="${esc(curProfile.avatar_url)}" alt=""/>`
    : (curProfile?.username||'?')[0].toUpperCase();
  const otherAv = curOtherUser?.avatar_url
    ? `<img src="${esc(curOtherUser.avatar_url)}" alt=""/>`
    : (curOtherUser?.username||'?')[0].toUpperCase();
  const av = isMine ? myAv : otherAv;
  const d = new Date(msg.created_at);
  const time = d.toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit'});
  const status = isMine ? ' ‚úì' : '';
  const div = document.createElement('div');
  div.className = `msg ${isMine?'mine':'other'}`;
  div.innerHTML = `<div class="msg-av">${av}</div>
    <div>
      <div class="msg-bubble">${esc(msg.content)}</div>
      <span class="msg-time">${time}<span class="msg-status">${status}</span></span>
    </div>`;
  el.insertBefore(div, typingEl);
  scrollToBottom();
}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
async function sendMessage(){
  const inp = document.getElementById('chat-input');
  const content = inp.value.trim();
  if(!content || !curConvId) return;

  inp.value = '';
  inp.style.height = 'auto';
  document.getElementById('send-btn').disabled = true;

  // –õ–∏—á–Ω–æ–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
  if(isSelfChat){
    saveSelfMessage(content);
    return;
  }

  const {error} = await sb.from('messages').insert({
    conversation_id: curConvId,
    sender_id: curUser.id,
    content
  });
  if(error){ toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','bad'); return; }
  await sb.from('conversations').update({
    last_message: content,
    last_message_at: new Date().toISOString()
  }).eq('id', curConvId);
  await loadDialogs();
}

// ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ
function subscribeToConversation(convId){
  if(msgSubscription) sb.removeChannel(msgSubscription);
  msgSubscription = sb.channel('msgs-'+convId)
    .on('postgres_changes', {
      event:'INSERT', schema:'public', table:'messages',
      filter:`conversation_id=eq.${convId}`
    }, payload => {
      if(payload.new.sender_id !== curUser.id){
        appendMessage(payload.new);
        // –£–±–∏—Ä–∞–µ–º typing indicator
        document.getElementById('typing-indicator').classList.remove('show');
      }
    })
    .subscribe();
}

function subscribeToNewMessages(){
  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è conversations –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
  const ch = sb.channel('convs-'+curUser.id)
    .on('postgres_changes', {
      event:'UPDATE', schema:'public', table:'conversations'
    }, () => { loadDialogs(); })
    .subscribe();
}

// ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ
function onTyping(){
  const val = document.getElementById('chat-input').value;
  document.getElementById('send-btn').disabled = !val.trim();
}

// ‚îÄ‚îÄ NEW DM ‚îÄ‚îÄ
function openNewDM(){
  selectedUserId = null;
  document.getElementById('newdm-search').value = '';
  document.getElementById('user-pick-list').innerHTML = '<div class="upi-empty">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è</div>';
  document.getElementById('newdm-err').style.display='none';
  openOverlay('m-newdm');
}

let _uSearchT;
function searchUsers(){
  clearTimeout(_uSearchT);
  const q = document.getElementById('newdm-search').value.trim();
  if(q.length < 1){ document.getElementById('user-pick-list').innerHTML='<div class="upi-empty">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è</div>'; return; }
  _uSearchT = setTimeout(()=>_doSearchUsers(q), 300);
}

async function _doSearchUsers(q){
  const {data} = await sb.from('profiles')
    .select('id,username,avatar_url')
    .ilike('username', `%${q}%`)
    .neq('id', curUser.id)
    .limit(20);

  const el = document.getElementById('user-pick-list');
  if(!data?.length){ el.innerHTML='<div class="upi-empty">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  el.innerHTML = data.map(p => {
    const av = p.avatar_url
      ? `<img src="${esc(p.avatar_url)}" alt=""/>`
      : (p.username||'?')[0].toUpperCase();
    const sel = p.id === selectedUserId ? ' selected' : '';
    return `<div class="user-pick-item${sel}" onclick="selectUser('${p.id}','${esc(p.username||'')}',this)">
      <div class="upi-av">${av}</div>
      <div class="upi-name">${esc(p.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
    </div>`;
  }).join('');
}

function selectUser(id, name, el){
  selectedUserId = id;
  document.querySelectorAll('.user-pick-item').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
}

async function startDM(){
  const errEl = document.getElementById('newdm-err');
  errEl.style.display='none';
  if(!selectedUserId){ errEl.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; errEl.style.display='block'; return; }

  setLoad(true);
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –¥–∏–∞–ª–æ–≥
  const {data:existing} = await sb.from('conversations')
    .select('id')
    .or(`and(user1_id.eq.${curUser.id},user2_id.eq.${selectedUserId}),and(user1_id.eq.${selectedUserId},user2_id.eq.${curUser.id})`)
    .maybeSingle();

  let convId;
  if(existing){
    convId = existing.id;
  } else {
    const {data:newConv, error} = await sb.from('conversations').insert({
      user1_id: curUser.id,
      user2_id: selectedUserId
    }).select().single();
    if(error){ errEl.textContent='–û—à–∏–±–∫–∞: '+error.message; errEl.style.display='block'; setLoad(false); return; }
    convId = newConv.id;
  }

  setLoad(false);
  closeOverlay('m-newdm');
  await loadDialogs();
  openConversation(convId, selectedUserId);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function scrollToBottom(){
  const el = document.getElementById('chat-msgs');
  el.scrollTop = el.scrollHeight;
}

function autoResize(el){
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight, 120)+'px';
}

function showSidebar(){
  document.getElementById('sidebar').classList.remove('hidden');
  document.getElementById('chat-view').style.display='none';
  document.getElementById('chat-empty').style.display='flex';
  curConvId = null;
}

function fmtTime(iso){
  const d = new Date(iso);
  const now = new Date();
  const diff = now - d;
  if(diff < 86400000) return d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
  if(diff < 604800000) return d.toLocaleDateString('ru',{weekday:'short'});
  return d.toLocaleDateString('ru',{day:'numeric',month:'short'});
}

function openOverlay(id){ document.getElementById(id).classList.add('open'); }
function closeOverlay(id){ document.getElementById(id).classList.remove('open'); }
function setLoad(v){ document.getElementById('lov').classList.toggle('show',v); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let _tt;
function toast(msg, type='ok'){
  const el = document.getElementById('toast');
  el.textContent = (type==='ok'?'‚úì ':'‚úó ') + msg;
  el.className = 'toast show '+type;
  clearTimeout(_tt);
  _tt = setTimeout(()=>el.classList.remove('show'), 3000);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
document.querySelectorAll('.overlay').forEach(ov=>{
  ov.addEventListener('click', e=>{ if(e.target===ov) ov.classList.remove('open'); });
});
document.getElementById('sett-overlay').addEventListener('click', e=>{
  if(e.target===document.getElementById('sett-overlay')) closeSettings();
});

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
applyTheme(localStorage.getItem('rm-theme')||'forest');

// Enter –≤ –ø–æ–ª—è—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
document.getElementById('login-pass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('reg-name').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('reg-email').focus(); });
document.getElementById('reg-email').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('reg-pass').focus(); });
document.getElementById('reg-pass').addEventListener('keydown', e=>{ if(e.key==='Enter') doRegister(); });
</script>
</body>
</html>
